<div class="container-fluid p-4">
  <h3>Relatórios - Ordens de Serviço</h3>

  <!-- Barra única de filtros: Status | Marca | Serviço | Cliente -->
  <div class="row g-3 mb-3 align-items-center">
    <div class="col-md-3">
      <label class="form-label">Status</label>
      <div class="d-flex gap-2">
        <button id="btnStatusAberto" class="btn btn-outline-warning">Aberto</button>
        <button id="btnStatusConcluido" class="btn btn-outline-success">Concluído</button>
        <button id="btnPdfStatus" class="btn btn-success">Baixar PDF</button>
        <button id="btnPrintStatus" class="btn btn-outline-secondary">Imprimir</button>
      </div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Marca</label>
      <div class="d-flex">
        <select id="selectMarca" class="form-select">
          <option value="">-- Selecione uma marca --</option>
          <% if (marcas && marcas.length) { marcas.forEach(m => { %>
            <option value="<%= m.nome %>"><%= m.nome %></option>
          <% }) } %>
        </select>
        <button id="btnPdfMarca" class="btn btn-success ms-2">Baixar</button>
      </div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Serviço</label>
      <div class="d-flex">
        <select id="selectServico" class="form-select">
          <option value="">-- Selecione --</option>
          <% if (servicos && servicos.length) { servicos.forEach(s => { %>
            <option value="<%= s.id %>"><%= s.nome %></option>
          <% }) } %>
        </select>
        <button id="btnPdfServico" class="btn btn-success ms-2">Baixar</button>
      </div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Cliente</label>
      <div class="d-flex">
        <select id="selectCliente" class="form-select">
          <option value="">-- Selecione um cliente --</option>
          <% if (clientes && clientes.length) { clientes.forEach(c => { %>
            <option value="<%= c %>"><%= c %></option>
          <% }) } %>
        </select>
        <button id="btnPdfCliente" class="btn btn-success ms-2">Baixar</button>
      </div>
    </div>
  </div>

  <div id="relatorioGeral" class="mt-3"></div>
</div>

<script>
  // Função auxiliar para formatar data
  function formatarData(dataStr) {
    if (!dataStr) return 'N/A';
    const data = new Date(dataStr);
    return data.toLocaleString('pt-BR');
  }

  // Função auxiliar para gerar tabela
  function gerarTabela(ordens) {
    if (!ordens || ordens.length === 0) {
      return '<div class="alert alert-info">Nenhum resultado encontrado.</div>';
    }

    let html = '<table class="table table-striped table-hover"><thead class="table-dark"><tr>';
    html += '<th>ID</th><th>Serviço</th><th>Cliente</th><th>Equipamento</th><th>Data Abertura</th><th>Data Conclusão</th><th>Status</th>';
    html += '</tr></thead><tbody>';

    for (let o of ordens) {
      const equip = o.equipamento_nome ? `${o.equipamento_nome} <br/><small>(${o.marca || 'N/A'})</small>` : '<em>Sem equipamento</em>';
      const statusBadge = o.status === 'aberta' 
        ? '<span class="badge bg-warning">Aberto</span>' 
        : '<span class="badge bg-success">Concluído</span>';
      
      html += `<tr>`;
      html += `<td>${o.id || ''}</td>`;
      html += `<td>${o.servico_nome || 'N/A'}</td>`;
      html += `<td>${o.cliente || 'N/A'}</td>`;
      html += `<td>${equip}</td>`;
      html += `<td>${formatarData(o.data_abertura)}</td>`;
      html += `<td>${formatarData(o.data_conclusao)}</td>`;
      html += `<td>${statusBadge}</td>`;
      html += `</tr>`;
    }

    html += '</tbody></table>';
    return html;
  }

  // Estado atual do filtro mostrado
  let currentFilter = { type: 'status', value: 'aberta' };

  async function renderRelatorio(url, filterType, filterValue) {
    try {
      const response = await fetch(url);
      const data = await response.json();
      if (!data.ok) {
        document.getElementById('relatorioGeral').innerHTML = '<div class="alert alert-danger">Erro ao buscar dados.</div>';
        return;
      }
      document.getElementById('relatorioGeral').innerHTML = gerarTabela(data.ordens);
      currentFilter = { type: filterType, value: filterValue };
    } catch (err) {
      console.error(err);
      document.getElementById('relatorioGeral').innerHTML = '<div class="alert alert-danger">Erro na requisição.</div>';
    }
  }

  // Handlers de Status
  document.getElementById('btnStatusAberto').addEventListener('click', function() { renderRelatorio('/relatorio/status?status=aberta', 'status', 'aberta'); });
  document.getElementById('btnStatusConcluido').addEventListener('click', function() { renderRelatorio('/relatorio/status?status=concluida', 'status', 'concluida'); });
  document.getElementById('btnPdfStatus').addEventListener('click', function() {
    const status = (currentFilter.type === 'status') ? currentFilter.value : 'aberta';
    window.open(`/relatorios/pdf?type=status&status=${encodeURIComponent(status)}`, '_blank');
  });

  // Handlers Marca/Serviço/Cliente: atualizam tabela ao mudar select
  document.getElementById('selectMarca').addEventListener('change', function() {
    const marca = this.value;
    if (!marca) { document.getElementById('relatorioGeral').innerHTML = ''; return; }
    renderRelatorio(`/relatorio/marca?marca=${encodeURIComponent(marca)}`, 'marca', marca);
  });
  document.getElementById('btnPdfMarca').addEventListener('click', function() {
    const marca = document.getElementById('selectMarca').value;
    if (!marca) { alert('Selecione uma marca'); return; }
    window.open(`/relatorios/pdf?type=marca&marca=${encodeURIComponent(marca)}`, '_blank');
  });

  document.getElementById('selectServico').addEventListener('change', function() {
    const servicoId = this.value;
    if (!servicoId) { document.getElementById('relatorioGeral').innerHTML = ''; return; }
    renderRelatorio(`/relatorio/servico?servico_id=${encodeURIComponent(servicoId)}`, 'servico', servicoId);
  });
  document.getElementById('btnPdfServico').addEventListener('click', function() {
    const servicoId = document.getElementById('selectServico').value;
    if (!servicoId) { alert('Selecione um serviço'); return; }
    window.open(`/relatorios/pdf?type=servico&servico_id=${encodeURIComponent(servicoId)}`, '_blank');
  });

  document.getElementById('selectCliente').addEventListener('change', function() {
    const cliente = this.value;
    if (!cliente) { document.getElementById('relatorioGeral').innerHTML = ''; return; }
    renderRelatorio(`/relatorio/cliente?cliente=${encodeURIComponent(cliente)}`, 'cliente', cliente);
  });
  document.getElementById('btnPdfCliente').addEventListener('click', function() {
    const cliente = document.getElementById('selectCliente').value;
    if (!cliente) { alert('Selecione um cliente'); return; }
    window.open(`/relatorios/pdf?type=cliente&cliente=${encodeURIComponent(cliente)}`, '_blank');
  });

  // Imprimir o conteúdo atual
  document.getElementById('btnPrintStatus').addEventListener('click', function() {
    const content = document.getElementById('relatorioGeral').innerHTML;
    if (!content || !content.trim()) { alert('Gere um relatório primeiro!'); return; }
    const printWindow = window.open('', '', 'width=900,height=600');
    printWindow.document.write(`
      <html><head><title>Relatório</title>
      <link rel="stylesheet" href="/assets/css/main.css">
      </head><body>${content}</body></html>
    `);
    printWindow.print();
  });

  // Auto-carregar relatório de 'aberta' ao entrar
  renderRelatorio('/relatorio/status?status=aberta', 'status', 'aberta');
</script>

